# Monkey’s Paw – Cursed Wish Generator

An Angular + FastAPI app where users make (up to 3) wishes and receive a dark, witty twist generated by Google Gemini.

## Overview
Users submit a wish. The backend:
1. Enforces per‐session (3 wishes), per‑IP, and daily global limits.
2. Caches identical wish twists (reduces token usage).
3. Calls Gemini (server side only) to produce a single-sentence “cursed” twist.
4. Returns the structured response to the frontend chat UI.

## Stack
| Layer     | Tech |
|-----------|------|
| Frontend  | Angular |
| Backend   | FastAPI (Python) |
| AI Model  | google.generativeai (Gemini) |
| Storage   | In‑memory (ephemeral) |
| Styling   | SCSS |

## Features
- 3 wishes per in‑memory session
- Per‑IP rate limiting window (default 20 / 60s)
- Daily global twist cap (default 500)
- Duplicate wish caching (1h TTL)
- Reset endpoint (/wishes/reset)
- Limits endpoint (/limits)
- CORS locked to dev origins
- Clean separation of AI call (no key in client)

## Data Models

WishRequest (request body):
```json
{ "wish": "I want infinite money" }
```

WishResponse (example):
```json
{
  "id": 1,
  "wish": "I want infinite money",
  "twist": "Your wish 'I want infinite money' is granted... but with a twist. ...",
  "timestamp": "2025-08-20T12:34:56.789000"
}
```

NOTE: Depending on code version the field may be named `twist`, `twisted`, or `consequence`. Standardize to `twist` for consistency.

## API Endpoints

| Method | Path              | Description |
|--------|-------------------|-------------|
| POST   | /wishes           | Create a new wish (body: WishRequest) |
| GET    | /wishes           | List current (session) wishes |
| DELETE | /wishes/{id}      | Delete a wish by id |
| POST   | /wishes/reset     | Clear all wishes & reset id counter |
| GET    | /limits           | Show remaining per‑IP, daily, and session counts |

Rate limit / cap errors return HTTP 429:
```json
{ "detail": "Rate limit exceeded" }
```
or
```json
{ "detail": "Daily cap reached" }
```

## Environment Variables

Create `.env` (not committed):
```
GENAI_API_KEY=YOUR_GEMINI_KEY
```

Optional (tune limits by editing code constants):
- RATE_WINDOW_SECONDS
- MAX_REQ_PER_IP
- DAILY_CAP
- CACHE_TTL_SECONDS

 a `.env.example` for contributors:
```
GENAI_API_KEY=PUT_KEY_HERE
```

## Local Setup

Backend:
```bash
cd backend
python -m venv .venv
# Windows:
.venv\Scripts\activate
pip install -r requirements.txt
uvicorn backend.app:app --reload --port 8000
```

Frontend:
```bash
cd frontend
npm install
npm start        # or: ng serve
# Visit http://localhost:4200
```

Ensure frontend environment (e.g. `src/environments/environment.ts`):
```ts
export const environment = {
  production: false,
  apiBase: 'http://localhost:8000'
};
```

## Example Calls

Create wish:
```bash
curl -X POST http://localhost:8000/wishes \
  -H "Content-Type: application/json" \
  -d "{\"wish\":\"I want infinite money\"}"
```

Reset:
```bash
curl -X POST http://localhost:8000/wishes/reset
```

Limits:
```bash
curl http://localhost:8000/limits
```

## Rate Limiting Logic
- Per IP: sliding window (e.g. 20 requests / 60s) for any `/wishes*` path.
- Daily global cap: blocks once total processed wishes reaches threshold.
- Session cap: max 3 stored wishes (in-memory list).
- Cache: exact wish text (case-insensitive) avoids a second AI call for 1 hour.

## Token Usage Protection
- All AI requests originate server side; API key never reaches browser.
- Caching reduces redundant generations.
- Strict caps protect key from abuse if endpoint is shared publicly.

## Possible Enhancements
- Persist wishes in a database (SQLite/Postgres)
- Redis-backed distributed rate limiting
- Authentication / user accounts
- Structured logging (JSON)
- Unit/integration tests for limiter & cache
- Observability (OpenTelemetry)
- Docker / Compose setup

#

## Troubleshooting

| Issue | Cause | Fix |
|-------|-------|-----|
| 405 on OPTIONS | Path mismatch or missing CORS headers | Confirm route, CORS origins, no trailing slash mismatch |
| 422 body error | Field name mismatch (wish vs text) | Align frontend request model with backend Pydantic model |
| 429 errors | Limits hit | Wait window / reset / adjust constants |
| Empty twist | Model returned no direct `.text` | Add fallback parsing of candidates (see ai_service) |
| CORS error in browser only | Postman skips CORS | Ensure frontend origin in `ALLOWED_ORIGINS` |

## Security
- Do not commit `.env`.
- Rotate `GENAI_API_KEY` if exposed.



Enjoy your cursed wishes.

P.S. i will be deploying it soon.